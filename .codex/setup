#!/usr/bin/env bash
set -euo pipefail

# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘  Codex bootstrap: install all dependencies + Next.js build + test tools â•‘
# â•‘  (skipping static export and LHCI to stay under 300 s)                    â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

export npm_config_loglevel=error
echo "ğŸ”§  [setup] Installing project dependencies and building Next.jsâ€¦"

###############################################################################
# 1 â€” Project dependency installation                                         #
###############################################################################
if [[ -f pnpm-lock.yaml ]]; then
  corepack enable pnpm
  echo "ğŸ“¦  Installing via pnpm ci"
  pnpm install --frozen-lockfile --prefer-offline
elif [[ -f yarn.lock ]]; then
  corepack enable yarn
  echo "ğŸ“¦  Installing via yarn install"
  yarn install --immutable --check-cache
else
  echo "ğŸ“¦  Installing via npm ci"
  npm ci --prefer-offline --no-audit --progress=false
fi

###############################################################################
# 2 â€” Additional lint/test tools                                              #
###############################################################################
echo "ğŸ”§  Installing @eslint/js and Playwright for lint/test/e2eâ€¦"
npm install @eslint/js playwright --no-save

echo "ğŸ”§  Installing Playwright browsersâ€¦"
npx playwright install --with-deps

###############################################################################
# 3 â€” Persist Firebase key into .env                                           #
###############################################################################
if [[ -n "${FIREBASE_SERVICE_ACCOUNT_KEY_JSON:-}" ]]; then
  echo "ğŸ—   Writing FIREBASE_SERVICE_ACCOUNT_KEY_JSON to .env"
  printf "FIREBASE_SERVICE_ACCOUNT_KEY_JSON='%s'\n" \
    "${FIREBASE_SERVICE_ACCOUNT_KEY_JSON}" > .env
fi

###############################################################################
# 4 â€” Next.js build (skip static export and LHCI to stay under 300 s)         #
###############################################################################
echo "ğŸ›    Running npm run build"
npm run build

echo "âš ï¸   Skipping 'next export' and 'lhci autorun' to avoid 300 s timeout."

###############################################################################
# 5 â€” Helpful global tools (silent)                                           #
###############################################################################
npm install -g eslint prettier typescript firebase-tools > /dev/null 2>&1 || true

echo "âœ…  [setup] Dependencies installed, site built, and test tools ready."
