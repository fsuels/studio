#!/usr/bin/env bash
set -euo pipefail

# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘  Codex bootstrap: build only (skip long export â†’ LHCI to avoid 300 s timeout) â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

export CODEX_SETUP_TIMEOUT=$((15*60))   # 15-minute allowance
export PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=1
export npm_config_loglevel=error

echo "ðŸ”§  [setup] Starting environment bootstrapâ€¦"

# 1ï¸âƒ£  Install deps with existing lock-file
if   [[ -f pnpm-lock.yaml ]]; then
  corepack enable pnpm && pnpm install --frozen-lockfile --prefer-offline
elif [[ -f yarn.lock ]]; then
  corepack enable yarn && yarn install --immutable
else
  npm ci --prefer-offline --no-audit --progress=false
fi

# 2ï¸âƒ£  Persist Firebase key (if Codex injected it)
if [[ -n "${FIREBASE_SERVICE_ACCOUNT_KEY_JSON:-}" ]]; then
  printf "FIREBASE_SERVICE_ACCOUNT_KEY_JSON='%s'\n" \
    "${FIREBASE_SERVICE_ACCOUNT_KEY_JSON}" >> .env
fi

# 3ï¸âƒ£  Build only (skip `npm run export` â†’ static export takes too long)
echo "ðŸ›   Building Next.js siteâ€¦"
npm run build

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# â”€â”€â”€ LONG RUN STEPS REMOVED TO PREVENT STARTUP TIMEOUT (300 s) â”€â”€â”€â”€â”€â”€â”€â”€â”€
# â”€â”€ `npm run export` (staticâ€export of 1609 pages) is skipped here â”€â”€â”€â”€
# â”€â”€â”€ `lhci autorun` (runs Portable Chrome + Lighthouse) is skipped â”€â”€â”€â”€
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# 4ï¸âƒ£  Small CLIs Codex sometimes calls
npm install -g eslint prettier typescript firebase-tools > /dev/null 2>&1

echo "âœ…  Setup finished â€“ ready for Codex."
